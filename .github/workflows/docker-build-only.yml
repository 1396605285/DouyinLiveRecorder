name: Build Arm32v7 Docker Image (Node.js v22 LTS)

on:
  workflow_dispatch: # 手动触发

jobs:
  build-arm32v7:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    steps:
      - name: Checkout original code
        uses: actions/checkout@v4
        with:
          repository: ihmily/DouyinLiveRecorder
          ref: main

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: linux/arm/v7

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: |
            env.BUILDKIT_STEP_LOG_MAX_SIZE=52428800

      # 核心修改：安装 Node.js v22.11.0（ARMv7 32-bit 官方版）
      - name: Create arm32v7-compatible Dockerfile (Node.js v22)
        run: |
          cat > Dockerfile.arm32v7 << 'EOF'
          FROM python:3.11-slim-bookworm

          # 替换阿里云 Debian 源（加速 apt 安装）
          RUN sed -i "s/deb.debian.org/mirrors.aliyun.com/g" /etc/apt/sources.list.d/debian.sources \
              && sed -i "s/security.debian.org/mirrors.aliyun.com/g" /etc/apt/sources.list.d/debian.sources

          # 安装依赖：ffmpeg + 编译工具 + Node.js 依赖（curl 用于下载，xz-utils 用于解压）
          RUN apt-get update && apt-get install -y --no-install-recommends \
              ffmpeg gcc libc6-dev libffi-dev curl xz-utils \
              && rm -rf /var/lib/apt/lists/*

          # 安装 Node.js v22.11.0（ARMv7 32-bit 官方二进制包，你提供的链接）
          RUN curl -fsSL https://nodejs.org/dist/v22.11.0/node-v22.11.0-linux-armv7l.tar.xz -o node.tar.xz \
              && tar -xJf node.tar.xz -C /usr/local --strip-components=1 \
              && rm -f node.tar.xz \
              && node -v && npm -v # 验证安装成功（日志中会显示 v22.11.0）

          # 设置工作目录
          WORKDIR /app

          # 复制 Python 依赖文件并安装（阿里云 pip 源加速）
          COPY requirements.txt .
          RUN pip install --no-cache-dir -i https://mirrors.aliyun.com/pypi/simple/ \
              --trusted-host mirrors.aliyun.com \
              -r requirements.txt

          # 复制应用代码
          COPY . .

          # 启动命令（和原应用一致）
          CMD ["python", "main.py"]
          EOF

          # 打印 Dockerfile 确认配置
          cat Dockerfile.arm32v7

      # 构建镜像（标签更新为 v22 标识）
      - name: Build arm32v7 Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.arm32v7
          push: false
          platforms: linux/arm/v7
          tags: douyin-live-recorder:arm32v7-node22-lts # 标签含 Node.js 版本，便于区分
          cache-from: type=gha
          cache-to: type=gha,mode=max
          outputs: type=docker,dest=/tmp/douyin-live-recorder-arm32v7.tar

      # 上传镜像 tar 包（保留 14 天）
      - name: Upload image tar to Artifact
        uses: actions/upload-artifact@v4
        with:
          name: douyin-live-recorder-arm32v7
          path: /tmp/douyin-live-recorder-arm32v7.tar
          retention-days: 14
