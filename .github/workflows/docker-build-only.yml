name: Build Arm32v7 Docker Image (With Node.js)

on:
  workflow_dispatch: # 手动触发

jobs:
  build-arm32v7:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    steps:
      - name: Checkout original code
        uses: actions/checkout@v4
        with:
          repository: ihmily/DouyinLiveRecorder
          ref: main

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: linux/arm/v7

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: |
            env.BUILDKIT_STEP_LOG_MAX_SIZE=52428800

      # 核心修改：创建带 Node.js 16 的 Dockerfile（适配 arm32v7）
      - name: Create arm32v7-compatible Dockerfile (with Node.js)
        run: |
          cat > Dockerfile.arm32v7 << 'EOF'
          FROM python:3.11-slim-bookworm

          # 替换阿里云 Debian 源
          RUN sed -i "s/deb.debian.org/mirrors.aliyun.com/g" /etc/apt/sources.list.d/debian.sources \
              && sed -i "s/security.debian.org/mirrors.aliyun.com/g" /etc/apt/sources.list.d/debian.sources

          # 安装依赖：ffmpeg + 编译工具 + Node.js 依赖（curl、xz-utils）
          RUN apt-get update && apt-get install -y --no-install-recommends \
              ffmpeg gcc libc6-dev libffi-dev curl xz-utils \
              && rm -rf /var/lib/apt/lists/*

          # 安装 Node.js 16.20.2（最后支持 arm32v7 的 LTS 版）
          RUN curl -fsSL https://nodejs.org/dist/v16.20.2/node-v16.20.2-linux-armv7l.tar.xz -o node.tar.xz \
              && tar -xJf node.tar.xz -C /usr/local --strip-components=1 \
              && rm -f node.tar.xz \
              && node -v && npm -v # 验证安装成功

          # 设置工作目录
          WORKDIR /app

          # 复制依赖文件并安装 Python 依赖
          COPY requirements.txt .
          RUN pip install --no-cache-dir -i https://mirrors.aliyun.com/pypi/simple/ \
              --trusted-host mirrors.aliyun.com \
              -r requirements.txt

          # 复制应用代码
          COPY . .

          # 启动命令
          CMD ["python", "main.py"]
          EOF

          # 查看 Dockerfile 内容
          cat Dockerfile.arm32v7

      # 构建镜像
      - name: Build arm32v7 Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.arm32v7
          push: false
          platforms: linux/arm/v7
          tags: douyin-live-recorder:arm32v7-with-nodejs
          cache-from: type=gha
          cache-to: type=gha,mode=max
          outputs: type=docker,dest=/tmp/douyin-live-recorder-arm32v7.tar

      # 上传镜像
      - name: Upload image tar to Artifact
        uses: actions/upload-artifact@v4
        with:
          name: douyin-live-recorder-arm32v7
          path: /tmp/douyin-live-recorder-arm32v7.tar
          retention-days: 14
